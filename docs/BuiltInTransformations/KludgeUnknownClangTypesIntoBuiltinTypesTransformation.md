`KludgeUnknownClangTypesIntoBuiltinTypesTransformation`
===================================================================================================

<small>\[[Transformation Source](../../Biohazrd.CSharp/#Transformations/KludgeUnknownClangTypesIntoBuiltinTypesTransformation.cs)\]</small>

> # kludge
> [klo͞oj]
> ## Noun
> An ill-assorted collection of parts assembled to fulfil a particular purpose.
> 
> *Computing*: A machine, system, or program that has been badly put together, especially a clumsy but temporarily effective solution to a particular fault or problem.
>
> ## Verb
> Improvise or put together from an ill-assorted collection of parts.
>
> <p align="right"><small>Source: <a href="https://www.lexico.com/definition/kludge">Oxford Dictionary</a></small></p>

------------

This transformation attempts to kludge untranslatable types into C# built-in types of the same size. Generally you do not want it to actually run in your generator, but it can be a nice last restort to end up with a very-annoying-to-use-but-technically-usable interop library.

This translation is meant to make your output bearly more usable than it would be without. It is **not** intended to be part of your final translation pipeline strategy.

## When this transformation is applicable

This transformation can be nice while developing your generator and as a fail-safe fallback. If it changes your library, it will always emit a warning.

It does not hurt to leave this transformation in, but some may feel that if this transformation is necessary the output is broken regardless.

## Details

This transformation works by looking for any [`ClangTypeReference`](../BuiltInTypeReferences/ClangTypeReference.md)s left in your library. If they match the size of a C# built-in type, they are replaced wtih that built-in type. As such, this transformaiton must come after all type reduction transformations in your pipeliune.

Given the following C++ code:

```cpp
template <class T>
struct Pair
{
    T x;
    T y;
};

struct SomeStruct
{
    Pair<short> ShortPair;
    Pair<int> IntPair;
};
```

Biohazrd's translation stage will output the following declaration tree:

```
TranslatedUnsupportedDeclaration Pair
TranslatedRecord SomeStruct
    TranslatedNormalField ShortPair @ 0
    TranslatedNormalField IntPair @ 4
```

Note that `Pair` did not translate because C++ templates are not yet supported by Biohazrd.

If you attempted to generate C# from this declaration tree you'd end up with fairly broken output:

```csharp
// This file was automatically generated by Biohazrd and should not be modified by hand!
using System.Runtime.InteropServices;

/* Failed to emit TranslatedUnsupportedDeclaration Pair: ClassTemplateDecl/ClassTemplate/FirstRedeclarableTemplate Clang declarations are not supported. */

[StructLayout(LayoutKind.Explicit, Size = 12)]
public unsafe partial struct SomeStruct
{
    [FieldOffset(0)] public /* Failed to emit TranslatedNormalField ShortPair: ClangTypeReference is not supported by the C# output generator. */
    int ShortPair;

    [FieldOffset(4)] public /* Failed to emit TranslatedNormalField IntPair: ClangTypeReference is not supported by the C# output generator. */
    int IntPair;
}
```

(Note: [#109](https://github.com/InfectedLibraries/Biohazrd/issues/109) covers using a more preferable type than `int` for the last-chance fallback.)

Along with this mess of diagnostics:

```
⚠ Warning at KludgeUnknownClangTypesIntoBuiltinTypesTransformation.h:1: Templates are not supported.
⛔ Error: Could not emit TranslatedUnsupportedDeclaration Pair @ TranslatedLibrary: ClassTemplateDecl/ClassTemplate/FirstRedeclarableTemplate Clang declarations are not supported.
⛔ Error: Could not emit TranslatedNormalField ShortPair @ TranslatedLibrary.SomeStruct: ClangTypeReference is not supported by the C# output generator.
⛔ Error: Could not emit TranslatedNormalField IntPair @ TranslatedLibrary.SomeStruct: ClangTypeReference is not supported by the C# output generator.
```

A proper solution would probably be to add a custom transformation that translates `Pair` as a C# tuple, but let's presume for now that this is an issue that has popped up for one of your users while trying to upgrade your interop library to a newer version of the native library. In this situation, the user might not have the time or know-how to write this transformation, but they still want a library which is usable (even if it isn't ideal.)

This is the type of situation `KludgeUnknownClangTypesIntoBuiltinTypesTransformation` is intended for.

After applying the transformation, the C# code looks like this:

```csharp
// This file was automatically generated by Biohazrd and should not be modified by hand!
using System.Runtime.InteropServices;

/* Failed to emit TranslatedUnsupportedDeclaration Pair: ClassTemplateDecl/ClassTemplate/FirstRedeclarableTemplate Clang declarations are not supported. */

[StructLayout(LayoutKind.Explicit, Size = 12)]
public unsafe partial struct SomeStruct
{
    [FieldOffset(0)] public uint ShortPair;

    [FieldOffset(4)] public ulong IntPair;
}
```

Notice that `Pair<short, short>` became a `uint`. This is obviously not the same type, but it is the same size. Someone could use masks and bit shifting to access the members of `ShortPair`.

For example, here's some C code alongside some equivalent kludged C# code:

<table><tr>
<td>

```c
void PrintY(SomeStruct* s)
{
    short y = s->ShortPair.y;
    printf("y = %d\n", y);
}
```
</td>
<td>

```csharp
void PrintY(in SomeStruct s)
{
    short y = (short)(s.ShortPair >> 16);
    Console.WriteLine($"y = {y}\n");
}
```
</td>
</tr></table>

Also, as mentioned earlier, this transformation **always** emits warnings when it modifies your library:

```
------------------- TranslatedUnsupportedDeclaration Pair --------------------
⚠ Warning at KludgeUnknownClangTypesIntoBuiltinTypesTransformation.h:1: Templates are not supported.
---------------------- TranslatedNormalField ShortPair -----------------------
⚠ Warning: Type '`Pair<short>`' could not be transformed and was kludged into a System.UInt32.
----------------------- TranslatedNormalField IntPair ------------------------
⚠ Warning: Type '`Pair<int>`' could not be transformed and was kludged into a System.UInt64.
```
